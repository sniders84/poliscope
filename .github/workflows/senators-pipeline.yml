      - name: Generate senators-rankings.json
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
        run: |
          mkdir -p poliscope/public

          cat > generate.mjs << 'EOF'
          import fs from "fs";

          const OUTPUT_PATH = "poliscope/public/senators-rankings.json";
          const LEGISLATORS_URL = "https://unitedstates.github.io/congress-legislators/legislators-current.json";
          const BASE_URL = "https://api.congress.gov/v3";
          const API_KEY = process.env.CONGRESS_API_KEY;

          if (!API_KEY) {
            console.error("CONGRESS_API_KEY secret is missing!");
            process.exit(1);
          }

          async function getJSON(baseUrl) {
            const url = `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}api_key=${API_KEY}&limit=250&format=json`;
            const res = await fetch(url);
            if (!res.ok) {
              const text = await res.text();
              throw new Error(`HTTP ${res.status} for ${url}: ${text.substring(0, 200)}`);
            }
            return res.json();
          }

          async function getLegislationCount(bioguide, type) {  // "sponsored-legislation" or "cosponsored-legislation"
            try {
              const data = await getJSON(`${BASE_URL}/member/${bioguide}/${type}`);
              return data.pagination?.count ?? 0;
            } catch (err) {
              console.warn(`Failed to fetch ${type} for ${bioguide}: ${err.message}`);
              return 0;
            }
          }

          async function build() {
            const legislators = await fetch(LEGISLATORS_URL).then(r => {
              if (!r.ok) throw new Error("Failed to fetch legislators");
              return r.json();
            });

            const currentDate = new Date().toISOString().slice(0, 10);
            const senators = legislators.filter(l =>
              l.terms.some(t => t.type === "sen" && t.end > currentDate)
            );

            console.log(`Found ${senators.length} current senators`);

            const rankings = [];

            for (const senator of senators) {
              const currentTerm = senator.terms.at(-1);
              const bioguide = senator.id.bioguide
