      - name: Generate senators-rankings.json
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
        run: |
          mkdir -p poliscope/public
          cat <<'EOF' > generate.mjs
import fs from "fs";

const OUTPUT_PATH = "poliscope/public/senators-rankings.json";
const LEGISLATORS_URL = "https://unitedstates.github.io/congress-legislators/legislators-current.json";
const BASE_URL = "https://api.congress.gov/v3";
const API_KEY = process.env.CONGRESS_API_KEY;

if (!API_KEY) {
  console.error("CONGRESS_API_KEY secret is missing!");
  process.exit(1);
}

async function getJSON(path) {
  const url = `${BASE_URL}/${path}?api_key=${API_KEY}&limit=250&format=json`;
  console.log(`Fetching: ${url}`);
  const res = await fetch(url);
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`HTTP ${res.status} for ${url}: ${text.substring(0, 300)}`);
  }
  return res.json();
}

async function getLegislationCount(bioguide, type) {  // "sponsored-legislation" or "cosponsored-legislation"
  try {
    const data = await getJSON(`member/${bioguide}/${type}`);
    const count = data.pagination?.count ?? 0;
    console.log(`  ${type}: ${count}`);
    return count;
  } catch (err) {
    console.warn(`Failed to fetch ${type} for ${bioguide}: ${err.message}`);
    return 0;
  }
}

async function build() {
  const legislators = await fetch(LEGISLATORS_URL).then(r => r.json());

  const currentDate = new Date().toISOString().slice(0, 10);
  const senators = legislators.filter(l =>
    l.terms.some(t => t.type === "sen" && t.end > currentDate)
  );

  console.log(`Found ${senators.length} current senators`);

  const rankings = [];

  for (const senator of senators) {
    const currentTerm = senator.terms.at(-1);
    const bioguide = senator.id.bioguide;
    const name = `${senator.name.first} ${senator.name.last}`;
    const party = currentTerm.party === "Democrat" ? "Democrat" :
                  currentTerm.party === "Republican" ? "Republican" : "Independent";
    const state = currentTerm.state;

    console.log(`Processing ${name} (${bioguide})`);

    const bills_introduced = await getLegislationCount(bioguide, "sponsored-legislation");
    const bills_cosponsored = await getLegislationCount(bioguide, "cosponsored-legislation");

    rankings.push({
      name,
      office: "Senator",
      party,
      state,
      missed_votes_pct: 0,
      bills_introduced,
      bills_cosponsored,
      laws_enacted: 0,
      committee_positions_score: 0,
      bills_out_of_committee: 0,
      misconduct: 0
    });
  }

  rankings.sort((a, b) => a.name.localeCompare(b.name));

  fs.writeFileSync(OUTPUT_PATH, JSON.stringify(rankings, null, 2));
  console.log(`âœ… senators-rankings.json generated with ${rankings.length} senators and real sponsorship/cosponsorship counts!`);
}

build().catch(err => {
  console.error("Script failed:", err);
  process.exit(1);
});
EOF
          node --experimental-fetch generate.mjs
