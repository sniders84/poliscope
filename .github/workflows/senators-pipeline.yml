name: Senators Rankings Pipeline (career totals: robust bioguide + laws enacted)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 5 * * *"   # nightly at 05:00 UTC

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Generate senators-rankings.json (career totals: laws enacted)
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const API_KEY = process.env.CONGRESS_API_KEY;
          const senatorsPath = path.join(process.cwd(), 'public', 'senators.json');
          const legislatorsPath = path.join(process.cwd(), 'public', 'legislators-current.json');

          const senators = JSON.parse(fs.readFileSync(senatorsPath, 'utf-8'));
          const legislators = JSON.parse(fs.readFileSync(legislatorsPath, 'utf-8'));

          // Helpers: congress number math
          function yearToCongress(year) {
            // 1st Congress: 1789-1791, increments every 2 years
            return Math.floor((year - 1789) / 2) + 1;
          }
          function currentCongress() {
            const now = new Date();
            const y = now.getUTCFullYear();
            return yearToCongress(y);
          }

          // Build lookup: variants + state-qualified keys, and store terms by bioguide
          const bioguideMap = {};
          const termsByBioguide = {};
          legislators.forEach(l => {
            const id = l?.id?.bioguide;
            if (!id) return;

            const first = l?.name?.first || '';
            const nick = l?.name?.nickname || '';
            const last = l?.name?.last || '';
            const full = l?.name?.official_full || '';
            const state = (l?.terms || []).slice(-1)[0]?.state || (l?.terms || [])[0]?.state || '';

            termsByBioguide[id] = Array.isArray(l?.terms) ? l.terms : [];

            const variants = [
              `${first} ${last}`,
              `${nick} ${last}`,
              full
            ];

            variants
              .filter(Boolean)
              .forEach(v => {
                const k = v.trim().toLowerCase();
                if (k) bioguideMap[k] = id;
                if (k && state) bioguideMap[`${k} (${state.toUpperCase()})`] = id;
              });

            if (last && state) {
              bioguideMap[`${last.toLowerCase()} (${state.toUpperCase()})`] = id;
            }
          });

          function normalizeParty(party) {
            if (!party) return null;
            const s = String(party).trim().toLowerCase();
            if (s.startsWith('r')) return 'R';
            if (s.startsWith('d')) return 'D';
            if (s.startsWith('i')) return 'I';
            return party;
          }

          async function fetchJSON(url) {
            try {
              const res = await fetch(url);
              if (!res.ok) {
                console.error('Fetch failed:', res.status, res.statusText, url);
                return null;
              }
              return res.json();
            } catch (err) {
              console.error('Error fetching JSON', url, err.message);
              return null;
            }
          }

          async function fetchCount(url) {
            try {
              const data = await fetchJSON(url);
              if (!data) return null;
              const c = data?.pagination?.count;
              return typeof c === 'number' ? c : null;
            } catch (err) {
              console.error('Error fetching count', url, err.message);
              return null;
            }
          }

          function getBillKey(it) {
            const congress = it?.congress || it?.bill?.congress;
            const billNumber = it?.number || it?.billNumber || it?.bill?.number;
            let billType = it?.type || it?.billType || it?.bill?.type;
            if (typeof billType === 'string') billType = billType.toLowerCase();
            if (!congress || !billType || !billNumber) return null;
            return { congress, billType, billNumber };
          }

          function textIsBecameLaw(txt) {
            if (!txt) return false;
            const t = String(txt).toLowerCase();
            return (
              t.includes('became law') ||
              t.includes('became public law') ||
              t.includes('became private law') ||
              t.includes('public law') && t.includes('became')
            );
          }

          // Normalize actions list from bill detail response
          function normalizeActions(bill) {
            const actionsRaw = bill?.bill?.actions || bill?.actions || bill?.data?.actions;
            if (Array.isArray(actionsRaw)) return actionsRaw;
            return actionsRaw ? [actionsRaw] : [];
          }

          // Determine congress range from terms for this bioguide
          function congressRangeForMember(bioguide) {
            const terms = termsByBioguide[bioguide] || [];
            if (terms.length === 0) {
              // Fallback to a broad range if terms are missing
              return { start: 93, end: currentCongress() }; // 93rd (1973) to current
            }
            const years = terms.flatMap(t => {
              const ys = [];
              const start = parseInt(String(t.start).slice(0, 4), 10);
              const end = parseInt(String(t.end).slice(0, 4), 10);
              if (Number.isInteger(start)) ys.push(start);
              if (Number.isInteger(end)) ys.push(end);
              return ys;
            }).filter(Number.isInteger);

            const minYear = Math.min(...years);
            const maxYear = Math.max(...years);
            const start = yearToCongress(minYear);
            const end = Math.max(yearToCongress(maxYear), currentCongress());
            return { start, end };
          }

          // Fetch all sponsored bills across the member's career congress span and count "Became Law"
          async function fetchLawsEnactedCareer(bioguide) {
            const { start, end } = congressRangeForMember(bioguide);
            let enacted = 0;

            // modest concurrency to avoid rate limits
            const congressQueue = [];
            for (let c = start; c <= end; c++) congressQueue.push(c);

            async function processCongress(cn) {
              const base = `https://api.congress.gov/v3/member/${bioguide}/sponsored-legislation?api_key=${API_KEY}&limit=250&congress=${cn}`;
              const first = await fetchJSON(base);
              if (!first) return;

              const pages = first?.pagination?.pages || 1;
              const collectItems = data => (
                data?.results ||
                data?.sponsoredLegislation ||
                data?.data ||
                []
              );

              let items = collectItems(first);
              for (let p = 2; p <= pages; p++) {
                const data = await fetchJSON(`${base}&page=${p}`);
                if (!data) continue;
                items = items.concat(collectItems(data));
              }

              // detail calls per bill
              const limit = 5;
              let idx = 0;

              async function processOne(it) {
                const key = getBillKey(it);
                if (!key) return;

                const url = `https://api.congress.gov/v3/bill/${key.congress}/${key.billType}/${key.billNumber}?api_key=${API_KEY}`;
                const bill = await fetchJSON(url);
                if (!bill) return;

                const latestAction = bill?.bill?.latestAction || bill?.latestAction || bill?.data?.latestAction;
                const latestText = latestAction?.text || latestAction?.action || latestAction?.description;
                if (textIsBecameLaw(latestText)) {
                  enacted++;
                  return;
                }

                // Check actions log
                const actions = normalizeActions(bill);
                for (const a of actions) {
                  const t = a?.text || a?.action || a?.description;
                  if (textIsBecameLaw(t)) {
                    enacted++;
                    break;
                  }
                }

                // Extra safety: if public law number field exists
                const publicLawStr =
                  bill?.bill?.publicLawNumber ||
                  bill?.data?.publicLawNumber ||
                  bill?.publicLawNumber;
                if (publicLawStr) {
                  enacted++;
                }
              }

              async function worker() {
                while (idx < items.length) {
                  const i = idx++;
                  await processOne(items[i]);
                }
              }

              const workers = Array.from({ length: limit }, () => worker());
              await Promise.all(workers);
            }

            // Run with limited parallel congress processing
            const batchSize = 3;
            for (let i = 0; i < congressQueue.length; i += batchSize) {
              const batch = congressQueue.slice(i, i + batchSize).map(cn => processCongress(cn));
              await Promise.all(batch);
            }

            return enacted;
          }

          function resolveBioguide(s) {
            const name = s.name?.trim() || '';
            const state = s.state?.trim().toUpperCase() || '';
            const slug = s.slug ? s.slug.toLowerCase().replace(/-/g, ' ') : '';

            const key1 = name.toLowerCase();
            if (bioguideMap[key1]) return bioguideMap[key1];

            const key2 = `${key1} (${state})`;
            if (bioguideMap[key2]) return bioguideMap[key2];

            if (slug && bioguideMap[slug]) return bioguideMap[slug];
            if (slug) {
              const slugKeyState = `${slug} (${state})`;
              if (bioguideMap[slugKeyState]) return bioguideMap[slugKeyState];
            }

            const lastName = name.split(' ').slice(-1)[0].toLowerCase();
            const lastStateKey = `${lastName} (${state})`;
            if (bioguideMap[lastStateKey]) return bioguideMap[lastStateKey];

            const candidates = Object.keys(bioguideMap).filter(k => k.endsWith(lastName));
            const stateCandidates = candidates.filter(k => k.endsWith(`(${state})`.toLowerCase()));
            const pick = (stateCandidates[0] || candidates[0]);
            return pick ? bioguideMap[pick] : null;
          }

          async function buildRecord(s) {
            const bioguide = resolveBioguide(s);

            let bills_introduced = null;
            let bills_cosponsored = null;
            let laws_enacted = null;

            if (bioguide && API_KEY) {
              bills_introduced = await fetchCount(`https://api.congress.gov/v3/member/${bioguide}/sponsored-legislation?api_key=${API_KEY}`);
              bills_cosponsored = await fetchCount(`https://api.congress.gov/v3/member/${bioguide}/cosponsored-legislation?api_key=${API_KEY}`);
              laws_enacted = await fetchLawsEnactedCareer(bioguide);
            } else {
              console.warn('Missing bioguide for', s.name, s.state || '');
            }

            return {
              name: s.name,
              office: s.office || 'Senator',
              party: normalizeParty(s.party),
              state: s.state,
              missed_votes_pct: null,
              bills_introduced,
              bills_cosponsored,
              laws_enacted,
              committee_positions_score: null,
              bills_out_of_committee: null,
              misconduct: 0
            };
          }

          (async () => {
            const records = [];
            for (const s of senators) {
              const rec = await buildRecord(s);
              records.push(rec);
              const resolved = resolveBioguide(s);
              console.log('OK:', rec.name, rec.state || '', 'bioguide:', resolved || 'MISSING', 'laws_enacted:', rec.laws_enacted);
            }
            const outFile = path.join(process.cwd(), 'public', 'senators-rankings.json');
            fs.writeFileSync(outFile, JSON.stringify(records, null, 2), 'utf-8');
            console.log('Wrote', records.length, 'senators to', outFile);
          })();
          NODE

      - name: Commit updated JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/senators-rankings.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update senators-rankings.json (career laws_enacted)"
            git push
          fi
