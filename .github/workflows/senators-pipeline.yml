name: "Senators Rankings Pipeline (current congress)"
on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *" # nightly at 05:00 UTC
jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Generate senators-rankings.json
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
          PROPUBLICA_API_KEY: ${{ secrets.PROPUBLICA_API_KEY }}
        run: |-
          node <<'EOF'
          const fs = require('fs');
          const path = require('path');

          const CONGRESS_API_KEY = process.env.CONGRESS_API_KEY;
          const PROPUBLICA_API_KEY = process.env.PROPUBLICA_API_KEY;

          const base = path.join(process.cwd(), 'poliscope', 'public');

          if (!fs.existsSync(path.join(base, 'senators.json')) || !fs.existsSync(path.join(base, 'legislators-current.json'))) {
            console.error('Input files not found in poliscope/public');
            process.exit(1);
          }

          const senators = JSON.parse(fs.readFileSync(path.join(base, 'senators.json'), 'utf-8'));
          const legislators = JSON.parse(fs.readFileSync(path.join(base, 'legislators-current.json'), 'utf-8'));

          function yearToCongress(year) {
            return Math.floor((year - 1789) / 2) + 1;
          }
          const congress = yearToCongress(new Date().getUTCFullYear());

          async function fetchJSON(url, headers = {}) {
            try {
              const res = await fetch(url, { headers });
              if (!res.ok) return null;
              return await res.json();
            } catch {
              return null;
            }
          }

          async function fetchCount(url) {
            const data = await fetchJSON(url);
            return data?.pagination?.count ?? null;
          }

          function becameLawLatest(txt) {
            const t = (txt || '').toLowerCase();
            return t.includes('became law') || t.includes('became public law') || t.includes('became private law');
          }

          const bioguideByName = {};
          const bioguideByGovtrack = {};

          legislators.forEach(l => {
            const bioguide = l?.id?.bioguide;
            const govtrack = l?.id?.govtrack;
            if (!bioguide) return;
            const full = (l?.name?.official_full || '').toLowerCase();
            const first
