name: "Senators Rankings Pipeline (full metrics: introduced, cosponsored, enacted sponsored, missed votes, committee score, bills out of committee, misconduct)"

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 5 * * *"   # nightly at 05:00 UTC

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: "Generate senators-rankings.json (full career metrics)"
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
          PROPUBLICA_API_KEY: ${{ secrets.PROPUBLICA_API_KEY }}  # Add this secret in your repo settings from propublica.org
        shell: bash
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const CONGRESS_API_KEY = process.env.CONGRESS_API_KEY;
          const PROPUBLICA_API_KEY = process.env.PROPUBLICA_API_KEY;
          const senatorsPath = path.join(process.cwd(), 'public', 'senators.json');
          const legislatorsPath = path.join(process.cwd(), 'public', 'legislators-current.json');

          const senators = JSON.parse(fs.readFileSync(senatorsPath, 'utf-8'));
          const legislators = JSON.parse(fs.readFileSync(legislatorsPath, 'utf-8'));

          function yearToCongress(year) { return Math.floor((year - 1789) / 2) + 1; }
          function currentCongress() { return yearToCongress(new Date().getUTCFullYear()); }

          const bioguideMap = {};
          const termsByBioguide = {};
          legislators.forEach(l => {
            const id = l?.id?.bioguide;
            if (!id) return;
            termsByBioguide[id] = Array.isArray(l?.terms) ? l.terms : [];
            const first = l?.name?.first || '';
            const nick = l?.name?.nickname || '';
            const last = l?.name?.last || '';
            const full = l?.name?.official_full || '';
            const state = (l?.terms || []).slice(-1)[0]?.state || '';
            [ `${first} ${last}`, `${nick} ${last}`, full ].filter(Boolean).forEach(v => {
              const k = v.trim().toLowerCase();
              bioguideMap[k] = id;
              if (state) bioguideMap[`${k} (${state})`] = id;
            });
            if (last && state) bioguideMap[`${last.toLowerCase()} (${state})`] = id;
          });

          async function fetchJSON(url, headers = {}) {
            try { const res = await fetch(url, { headers }); if (!res.ok) return null; return res.json(); }
            catch { return null; }
          }

          async function fetchCount(baseUrl) {
            const url = `${baseUrl}?api_key=${CONGRESS_API_KEY}&limit=1`;
            const data = await fetchJSON(url);
            return data?.pagination?.count ?? null;
          }

          function getBillKey(it) {
            const congress = it?.congress || it?.bill?.congress;
            const billNumber = it?.number || it?.billNumber || it?.bill?.number;
            let billType = it?.type || it?.billType || it?.bill?.type;
            if (typeof billType === 'string') billType = billType.toLowerCase();
            if (!congress || !billType || !billNumber) return null;
            return { congress, billType, billNumber };
          }

          function textIsBecameLaw(txt) {
            if (!txt) return false;
            const t = String(txt).toLowerCase();
            return t.includes('became law') || t.includes('became public law') || t.includes('became private law') || t.includes('signed by') || t.includes('enacted');
          }

          function congressRangeForMember(bioguide) {
            const terms = termsByBioguide[bioguide] || [];
            if (terms.length === 0) return { start: currentCongress() - 10, end: currentCongress() };
            const years = terms.flatMap(t => {
              const ys = [];
              const s = parseInt(String(t.start).slice(0,4),10);
              const e = parseInt(String(t.end).slice(0,4),10);
              if (Number.isInteger(s)) ys.push(s);
              if (Number.isInteger(e)) ys.push(e);
              return ys;
            });
            const minYear = Math.min(...years) || 2013;
            const maxYear = Math.max(...years) || new Date().getUTCFullYear();
            return { start: yearToCongress(minYear), end: yearToCongress(maxYear) };
          }

          async function fetchLawsEnactedCareer(bioguide) {
            const { start, end } = congressRangeForMember(bioguide);
            let enacted = 0;
            for (let cn = start; cn <= end; cn++) {
              const base = `https://api.congress.gov/v3/member/${bioguide}/sponsored-legislation?api_key=${CONGRESS_API_KEY}&limit=250&congress=${cn}`;
              let offset = 0;
              let items = [];
              while (true) {
                const url = `${base}&offset=${offset}`;
                const d = await fetchJSON(url);
                if (!d) break;
                const newItems = d?.sponsoredLegislation || [];
                items = items.concat(newItems);
                if (newItems.length < 250) break;
                offset += 250;
              }
              for (const it of items) {
                const latestText = (it?.latestAction?.text || '').toLowerCase();
                if (textIsBecameLaw(latestText)) { enacted++; continue; }
                const key = getBillKey(it);
                if (!key) continue;
                const billUrl = `https://api.congress.gov/v3/bill/${key.congress}/${key.billType}/${key.billNumber}?api_key=${CONGRESS_API_KEY}`;
                const bill = await fetchJSON(billUrl);
                if (!bill) continue;
                const billLatestText = (bill?.bill?.latestAction?.text || '').toLowerCase();
                if (textIsBecameLaw(billLatestText)) { enacted++; continue; }
                const pl = bill?.bill?.publicLawNumber || '';
                if (pl) enacted++;
                // Additional check for actions
                let actionOffset = 0;
                while (true) {
                  const actionsUrl = `https://api.congress.gov/v3/bill/${key.congress}/${key.billType}/${key.billNumber}/actions?api_key=${CONGRESS_API_KEY}&limit=250&offset=${actionOffset}`;
                  const actionsData = await fetchJSON(actionsUrl);
                  if (!actionsData) break;
                  const actions = actionsData?.actions || [];
                  for (const a of actions) {
                    const t = (a?.text || '').toLowerCase();
                    if (textIsBecameLaw(t)) { enacted++; break; }
                  }
                  if (actions.length < 250) break;
                  actionOffset += 250;
                }
              }
            }
            return enacted;
          }

          async function fetchMissedVotesPct(bioguide) {
            if (!PROPUBLICA_API_KEY) return null;
            const url = `https://api.propublica.org/congress/v1/members/${bioguide}.json`;
            const headers = { 'X-API-Key': PROPUBLICA_API_KEY };
            const data = await fetchJSON(url, headers);
            const role = data?.results?.[0]?.roles?.[0] || {};
            return role?.missed_votes_pct || null;
          }

          async function fetchCommitteePositionsScore(bioguide) {
            if (!PROPUBLICA_API_KEY) return null;
            const url = `https://api.propublica.org/congress/v1/members/${bioguide}.json`;
            const headers = { 'X-API-Key': PROPUBLICA_API_KEY };
            const data = await fetchJSON(url, headers);
            const role = data?.results?.[0]?.roles?.[0] || {};
            const committees = role?.committees || [];
            let score = committees.length;
            committees.forEach(c => {
              if (c.title === 'Chair') score += 5;
              else if (c.title === 'Vice Chair') score += 3;
              else if (c.title === 'Ranking Member') score += 4;
            });
            return score;
          }

          async function fetchBillsOutOfCommittee(bioguide) {
            const { start, end } = congressRangeForMember(bioguide);
            let count = 0;
            for (let cn = start; cn <= end; cn++) {
              const base = `https://api.congress.gov/v3/member/${bioguide}/sponsored-legislation?api_key=${CONGRESS_API_KEY}&limit=250&congress=${cn}`;
              let offset = 0;
              let items = [];
              while (true) {
                const url = `${base}&offset=${offset}`;
                const d = await fetchJSON(url);
                if (!d) break;
                const newItems = d?.sponsoredLegislation || [];
                items = items.concat(newItems);
                if (newItems.length < 250) break;
                offset += 250;
              }
              for (const it of items) {
                const latestText = (it?.latestAction?.text || '').toLowerCase();
                if (latestText.includes('reported to senate') || latestText.includes('passed senate') || latestText.includes('discharged from committee') || latestText.includes('floor')) {
                  count++;
                }
              }
            }
            return count;
          }

          function resolveBioguide(s) {
            const name = s.name?.trim() || '';
            const state = s.state?.trim().toUpperCase() || '';
            const slug = s.slug ? s.slug.toLowerCase().replace(/-/g,' ') : '';
            const key1 = name.toLowerCase();
            if (bioguideMap[key1]) return bioguideMap[key1];
            const key2 = `${key1} (${state})`;
            if (bioguideMap[key2]) return bioguideMap[key2];
            if (slug && bioguideMap[slug]) return bioguideMap[slug];
            if (slug) {
              const slugKeyState = `${slug} (${state})`;
              if (bioguideMap[slugKeyState]) return bioguideMap[slugKeyState];
            }
            const lastName = name.split(' ').slice(-1)[0].toLowerCase();
            const lastStateKey = `${lastName} (${state})`;
            if (bioguideMap[lastStateKey]) return bioguideMap[lastStateKey];
            return null;
          }

          function normalizeParty(party) {
            if (!party) return null;
            const s = String(party).trim().toLowerCase();
            if (s.startsWith('r')) return 'R';
            if (s.startsWith('d')) return 'D';
            if (s.startsWith('i')) return 'I';
            return party;
          }

          async function buildRecord(s) {
            const bioguide = resolveBioguide(s);
            let bills_introduced = null;
            let bills_cosponsored = null;
            let laws_enacted = 0;
            let missed_votes_pct = null;
            let committee_positions_score = null;
            let bills_out_of_committee = null;
            let misconduct = 0;

            if (bioguide && CONGRESS_API_KEY) {
              bills_introduced = await fetchCount(`https://api.congress.gov/v3/member/${bioguide}/sponsored-legislation`);
              bills_cosponsored = await fetchCount(`https://api.congress.gov/v3/member/${bioguide}/cosponsored-legislation`);
              laws_enacted = await fetchLawsEnactedCareer(bioguide);
              missed_votes_pct = await fetchMissedVotesPct(bioguide);
              committee_positions_score = await fetchCommitteePositionsScore(bioguide);
              bills_out_of_committee = await fetchBillsOutOfCommittee(bioguide);
              // misconduct remains 0; can add logic if needed
            } else {
              console.warn('Missing bioguide or API key for', s.name, s.state || '');
            }

            return {
              name: s.name,
              office: s.office || 'Senator',
              party: normalizeParty(s.party),
              state: s.state,
              missed_votes_pct,
              bills_introduced,
              bills_cosponsored,
              laws_enacted,
              committee_positions_score,
              bills_out_of_committee,
              misconduct
            };
          }

          (async () => {
            const records = [];
            for (const s of senators) {
              const rec = await buildRecord(s);
              records.push(rec);
              const resolved = resolveBioguide(s);
              console.log('OK:', rec.name, rec.state || '', 'bioguide:', resolved || 'MISSING', 
                'introduced:', rec.bills_introduced, 
                'cosponsored:', rec.bills_cosponsored, 
                'enacted:', rec.laws_enacted, 
                'missed_pct:', rec.missed_votes_pct,
                'committee_score:', rec.committee_positions_score,
                'out_of_committee:', rec.bills_out_of_committee);
            }
            const outFile = path.join(process.cwd(), 'public', 'senators-rankings.json');
            fs.writeFileSync(outFile, JSON.stringify(records, null, 2), 'utf-8');
            console.log('Wrote', records.length, 'senators to', outFile);
          })();
          NODE

      - name: Commit updated JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/senators-rankings.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update senators-rankings.json (full metrics)"
            git push
          fi
