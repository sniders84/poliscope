name: "Senators Rankings Pipeline (career totals)"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"   # nightly at 05:00 UTC

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Generate senators-rankings.json
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
          PROPUBLICA_API_KEY: ${{ secrets.PROPUBLICA_API_KEY }}
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const CONGRESS_API_KEY = process.env.CONGRESS_API_KEY;
          const PROPUBLICA_API_KEY = process.env.PROPUBLICA_API_KEY;

          const senators = JSON.parse(fs.readFileSync('poliscope/public/senators.json','utf-8'));
          const legislators = JSON.parse(fs.readFileSync('poliscope/public/legislators-current.json','utf-8'));

          // Utility
          async function fetchJSON(url, headers = {}) {
            try {
              const res = await fetch(url, { headers });
              if (!res.ok) return null;
              return res.json();
            } catch {
              return null;
            }
          }
          function yearToCongress(year){ return Math.floor((year-1789)/2)+1; }
          function currentCongress(){ return yearToCongress(new Date().getUTCFullYear()); }

          // Build ID maps
          const bioguideByName = {};
          const govtrackByBioguide = {};
          const bioguideByGovtrack = {};
          const termsByBioguide = {};

          legislators.forEach(l => {
            const bioguide = l?.id?.bioguide;
            const govtrack = l?.id?.govtrack;
            if (!bioguide) return;
            termsByBioguide[bioguide] = Array.isArray(l?.terms) ? l.terms : [];
            const full = (l?.name?.official_full || '').toLowerCase();
            const firstLast = `${l?.name?.first||''} ${l?.name?.last||''}`.trim().toLowerCase();
            const state = (l?.terms||[]).slice(-1)[0]?.state || '';
            [full, firstLast].forEach(k => {
              if (k) {
                bioguideByName[k] = bioguide;
                if (state) bioguideByName[`${k} (${state.toUpperCase()})`] = bioguide;
              }
            });
            if (govtrack) {
              govtrackByBioguide[bioguide] = govtrack;
              bioguideByGovtrack[`${govtrack}`] = bioguide;
            }
          });

          function congressRangeForMember(bioguide){
            const terms = termsByBioguide[bioguide] || [];
            if (terms.length === 0) return { start: 93, end: currentCongress() };
            const years = terms.flatMap(t => {
              const ys=[]; const s=parseInt(String(t.start).slice(0,4),10);
              const e=parseInt(String(t.end).slice(0,4),10);
              if(Number.isInteger(s)) ys.push(s);
              if(Number.isInteger(e)) ys.push(e);
              return ys;
            });
            const minYear = Math.min(...years);
            const maxYear = Math.max(...years);
            return { start: yearToCongress(minYear), end: Math.max(yearToCongress(maxYear), currentCongress()) };
          }

          function resolveBioguideFromSenator(s) {
            const nameKey = (s.name || '').toLowerCase();
            const state = (s.state || '').toUpperCase();
            // Try name and name+state
            let id = bioguideByName[nameKey] || bioguideByName[`${nameKey} (${state})`];
            if (id) return id;
            // Try govtrack URL in senators.json, extract numeric ID and map
            const url = s.govtrack || s.govtrack_url || s.govtrack_id || '';
            const m = String(url).match(/govtrack\.us\/congress\/members\/[^\/]+\/(\d+)/) || String(url).match(/(\d{4,})/);
            if (m && bioguideByGovtrack[m[1]]) return bioguideByGovtrack[m[1]];
            return null;
          }

          async function fetchPaginatedCountCareer(memberPathKey, bioguide) {
            const { start, end } = congressRangeForMember(bioguide);
            let total = 0;
            for (let cn = start; cn <= end; cn++) {
              const url = `https://api.congress.gov/v3/member/${bioguide}/${memberPathKey}?api_key=${CONGRESS_API_KEY}&congress=${cn}&limit=1`;
              const data = await fetchJSON(url);
              const count = data?.pagination?.count || 0;
              total += count;
            }
            return total;
          }

          async function fetchLawsEnactedCareer(bioguide, typeKey) {
            const { start, end } = congressRangeForMember(bioguide);
            let enacted = 0;
            const seen = new Set(); // dedupe by bill identifier
            for (let cn = start; cn <= end; cn++) {
              let offset = 0; const limit = 250;
              while (true) {
                const url = `https://api.congress.gov/v3/member/${bioguide}/${typeKey}?api_key=${CONGRESS_API_KEY}&congress=${cn}&limit=${limit}&offset=${offset}`;
                const d = await fetchJSON(url);
                if (!d) break;
                const key = typeKey === 'sponsored-legislation' ? 'sponsoredLegislation' : 'cosponsoredLegislation';
                const items = d[key] || [];
                for (const it of items) {
                  const id = it?.number || it?.billNumber || `${cn}-${it?.title || ''}`;
                  const latest = (it?.latestAction?.text || '').toLowerCase();
                  const becameLaw = latest.includes('became law') || latest.includes('became public law') || latest.includes('became private law');
                  const hasPL = !!it?.publicLawNumber;
                  if ((becameLaw || hasPL) && id && !seen.has(id)) {
                    seen.add(id);
                    enacted++;
                  }
                }
                if (items.length < limit) break;
                offset += limit;
              }
            }
            return enacted;
          }

          async function fetchMissedVotesCareer(bioguide) {
            if (!PROPUBLICA_API_KEY) return { missed: null, pct: null };
            const url = `https://api.propublica.org/congress/v1/members/${bioguide}.json`;
            const headers = { 'X-API-Key': PROPUBLICA_API_KEY };
            const data = await fetchJSON(url, headers);
            const roles = data?.results?.[0]?.roles || [];
            let missed = 0, total = 0;
            roles.forEach(r => {
              missed += r.missed_votes || 0;
              total += r.total_votes || 0;
            });
            const pct = total > 0 ? Number(((missed / total) * 100).toFixed(2)) : null;
            return { missed, pct };
          }

          async function fetchCommitteeScoreCareer(bioguide) {
            if (!PROPUBLICA_API_KEY) return null;
            const url = `https://api.propublica.org/congress/v1/members/${bioguide}.json`;
            const headers = { 'X-API-Key': PROPUBLICA_API_KEY };
            const data = await fetchJSON(url, headers);
            const roles = data?.results?.[0]?.roles || [];
            let score = 0;
            roles.forEach(role => {
              (role?.committees || []).forEach(c => {
                const t = (c.title || '').toLowerCase();
                if (t.includes('chair')) score += 5;
                else if (t.includes('ranking')) score += 4;
                else if (t.includes('vice')) score += 3;
                else score += 1;
              });
            });
            return score;
          }

          async function fetchBillsOutOfCommitteeCareer(bioguide) {
            const { start, end } = congressRangeForMember(bioguide);
            let count = 0;
            for (let cn = start; cn <= end; cn++) {
              let offset = 0; const limit = 250;
              while (true) {
                const url = `https://api.congress.gov/v3/member/${bioguide}/sponsored-legislation?api_key=${CONGRESS_API_KEY}&congress=${cn}&limit=${limit}&offset=${offset}`;
                const d = await fetchJSON(url);
                if (!d) break;
                const items = d.sponsoredLegislation || [];
                for (const it of items) {
                  const latest = (it?.latestAction?.text || '').toLowerCase();
                  if (latest.includes('floor consideration')) count++;
                }
                if (items.length < limit) break;
                offset += limit;
              }
            }
            return count;
          }

          async function fetchMisconduct(govtrackId) {
            // Placeholder until dataset wired
            return 0;
          }

          async function buildRecord(s) {
            const bioguide = resolveBioguideFromSenator(s);
            const govtrackId = s.govtrack_id || (bioguide ? govtrackByBioguide[bioguide] : null);

            let bills_introduced = null;
            let bills_cosponsored = null;
            let laws_enacted = 0;
            let not_vote = { missed: null, pct: null };
            let committee_positions = null;
            let bills_out_of_committee = null;
            let misconduct = 0;

            if (bioguide && CONGRESS_API_KEY) {
              bills_introduced = await fetchPaginatedCountCareer('sponsored-legislation', bioguide);
              bills_cosponsored = await fetchPaginatedCountCareer('cosponsored-legislation', bioguide);
              const sponsored_enacted = await fetchLawsEnactedCareer(bioguide, 'sponsored-legislation');
              const cosponsored_enacted = await fetchLawsEnactedCareer(bioguide, 'cosponsored-legislation');
              laws_enacted = sponsored_enacted + cosponsored_enacted;
              not_vote = await fetchMissedVotesCareer(bioguide);
              committee_positions = await fetchCommitteeScoreCareer(bioguide);
              bills_out_of_committee = await fetchBillsOutOfCommitteeCareer(bioguide);
              misconduct = govtrackId ? await fetchMisconduct(govtrackId) : 0;
            }

            return {
              name: s.name,
              office: s.office || 'Senator',
              party: s.party,
              state: s.state,
              not_vote,                      // { missed, pct }
              bills_introduced,              // career sum
              bills_cosponsored,             // career sum
              laws_enacted,                  // deduped
              committee_positions,           // career-weighted score
              bills_out_of_committee,        // “Floor consideration”
              misconduct
            };
          }

          (async () => {
            const records = [];
            for (const s of senators) {
              const rec = await buildRecord(s);
              records.push(rec);
              console.log('OK:', rec.name, rec.state || '', 'laws_enacted:', rec.laws_enacted, 'not_vote:', JSON.stringify(rec.not_vote));
            }
            const outFile = path.join(process.cwd(), 'poliscope', 'public', 'senators-rankings.json');
            fs.mkdirSync(path.dirname(outFile), { recursive: true });
            fs.writeFileSync(outFile, JSON.stringify(records, null, 2), 'utf-8');
            console.log('Wrote', records.length, 'senators to', outFile);
          })();
          NODE

      - name: Commit updated JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add poliscope/public/senators-rankings.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update senators-rankings.json (career totals, deduped, fixed schema)"
            git push
          fi
