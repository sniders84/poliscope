      - name: Generate senators-rankings.json (with robust bioguide matching)
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          const API_KEY = process.env.CONGRESS_API_KEY;
          const senatorsPath = path.join(process.cwd(), 'public', 'senators.json');
          const legislatorsPath = path.join(process.cwd(), 'public', 'legislators-current.json');

          const senators = JSON.parse(fs.readFileSync(senatorsPath, 'utf-8'));
          const legislators = JSON.parse(fs.readFileSync(legislatorsPath, 'utf-8'));

          // Build lookup with multiple name variants
          const bioguideMap = {};
          legislators.forEach(l => {
            if (l.id && l.id.bioguide) {
              const id = l.id.bioguide;
              const names = [];

              if (l.name) {
                if (l.name.official_full) names.push(l.name.official_full);
                if (l.name.first && l.name.last) names.push(\`\${l.name.first} \${l.name.last}\`);
                if (l.name.nickname && l.name.last) names.push(\`\${l.name.nickname} \${l.name.last}\`);
              }

              names.forEach(n => {
                if (n) bioguideMap[n.trim().toLowerCase()] = id;
              });
            }
          });

          function normalizeParty(party) {
            if (!party) return null;
            const s = String(party).trim().toLowerCase();
            if (s.startsWith('r')) return 'R';
            if (s.startsWith('d')) return 'D';
            if (s.startsWith('i')) return 'I';
            return party;
          }

          async function fetchCount(url) {
            try {
              const res = await fetch(url);
              if (!res.ok) {
                console.error('Fetch failed:', res.status, res.statusText, url);
                return null;
              }
              const data = await res.json();
              return (data.pagination && typeof data.pagination.count === 'number')
                ? data.pagination.count
                : null;
            } catch (err) {
              console.error('Error fetching', url, err.message);
              return null;
            }
          }

          function resolveBioguide(l) {
            const nameKey = l.name.trim().toLowerCase();
            if (bioguideMap[nameKey]) return bioguideMap[nameKey];

            if (l.slug && bioguideMap[l.slug.toLowerCase().replace(/-/g, ' ')]) {
              return bioguideMap[l.slug.toLowerCase().replace(/-/g, ' ')];
            }

            const lastName = l.name.split(' ').slice(-1)[0].toLowerCase();
            const match = Object.keys(bioguideMap).find(k => k.endsWith(lastName));
            return match ? bioguideMap[match] : null;
          }

          async function buildRecord(l) {
            const bioguide = resolveBioguide(l);

            let bills_introduced = null;
            let bills_cosponsored = null;

            if (bioguide && API_KEY) {
              bills_introduced = await fetchCount(\`https://api.congress.gov/v3/member/\${bioguide}/sponsored-legislation?api_key=\${API_KEY}\`);
              bills_cosponsored = await fetchCount(\`https://api.congress.gov/v3/member/\${bioguide}/cosponsored-legislation?api_key=\${API_KEY}\`);
            } else {
              console.warn('Missing bioguide for', l.name);
            }

            return {
              name: l.name,
              office: l.office || 'Senator',
              party: normalizeParty(l.party),
              state: l.state,
              missed_votes_pct: null,
              bills_introduced,
              bills_cosponsored,
              laws_enacted: null,
              committee_positions_score: null,
              bills_out_of_committee: null,
              misconduct: 0
            };
          }

          (async () => {
            const records = [];
            for (const l of senators) {
              const rec = await buildRecord(l);
              records.push(rec);
              console.log('OK:', rec.name, 'bioguide:', resolveBioguide(l) || 'MISSING');
            }
            const outFile = path.join(process.cwd(), 'public', 'senators-rankings.json');
            fs.writeFileSync(outFile, JSON.stringify(records, null, 2), 'utf-8');
            console.log('Wrote', records.length, 'senators to', outFile);
          })();
          "
