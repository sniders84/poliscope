name: "Senators Rankings Pipeline (current congress)"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"   # nightly at 05:00 UTC

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Generate senators-rankings.json
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
          PROPUBLICA_API_KEY: ${{ secrets.PROPUBLICA_API_KEY }}
        run: |
          node - <<'NODE'
const fs = require('fs');
const path = require('path');

const CONGRESS_API_KEY = process.env.CONGRESS_API_KEY;
const PROPUBLICA_API_KEY = process.env.PROPUBLICA_API_KEY;

// Detect base dir: prefer poliscope/public, fallback to public
const baseDirs = [
  path.join(process.cwd(), 'poliscope', 'public'),
  path.join(process.cwd(), 'public')
];
let base = null;
for (const dir of baseDirs) {
  if (
    fs.existsSync(path.join(dir, 'senators.json')) &&
    fs.existsSync(path.join(dir, 'legislators-current.json'))
  ) {
    base = dir;
    break;
  }
}
if (!base) {
  console.error('Missing input files. Checked both poliscope/public and public.');
  process.exit(1);
}

const senatorsPath = path.join(base, 'senators.json');
const legislatorsPath = path.join(base, 'legislators-current.json');
const outFile = path.join(base, 'senators-rankings.json');

const senators = JSON.parse(fs.readFileSync(senatorsPath, 'utf-8'));
const legislators = JSON.parse(fs.readFileSync(legislatorsPath, 'utf-8'));

// … all helper functions (fetchJSON, fetchCount, etc.) and buildRecord go here …

(async () => {
  const records = await Promise.all(senators.map(buildRecord));
  fs.mkdirSync(path.dirname(outFile), { recursive: true });
  fs.writeFileSync(outFile, JSON.stringify(records, null, 2), 'utf-8');
  console.log('Wrote', records.length, 'senators to', outFile);
})();
NODE

      - name: Commit updated JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add poliscope/public/senators-rankings.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update senators-rankings.json (current congress)"
            git push
          fi
