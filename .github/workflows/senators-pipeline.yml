name: "Senators Rankings Pipeline (full metrics: introduced, cosponsored, enacted sponsored, missed votes, committee score, bills out of committee, misconduct)"

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 5 * * *"   # nightly at 05:00 UTC

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: "Generate senators-rankings.json (full career metrics)"
        env:
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
          PROPUBLICA_API_KEY: ${{ secrets.PROPUBLICA_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const CONGRESS_API_KEY = process.env.CONGRESS_API_KEY;
          const PROPUBLICA_API_KEY = process.env.PROPUBLICA_API_KEY;
          const senatorsPath = path.join(process.cwd(), 'public', 'senators.json');
          const legislatorsPath = path.join(process.cwd(), 'public', 'legislators-current.json');

          const senators = JSON.parse(fs.readFileSync(senatorsPath, 'utf-8'));
          const legislators = JSON.parse(fs.readFileSync(legislatorsPath, 'utf-8'));

          // helpers omitted for brevity (keep your existing ones)

          async function buildRecord(s) {
            const bioguide = resolveBioguide(s);
            let bills_introduced = null;
            let bills_cosponsored = null;
            let laws_enacted = 0;
            let missed_votes_pct = null;
            let committee_positions_score = null;
            let bills_out_of_committee = null;
            let misconduct = 0;

            if (bioguide && CONGRESS_API_KEY) {
              bills_introduced = await fetchCount(`https://api.congress.gov/v3/member/${bioguide}/sponsored-legislation`);
              bills_cosponsored = await fetchCount(`https://api.congress.gov/v3/member/${bioguide}/cosponsored-legislation`);
              laws_enacted = await fetchLawsEnactedCareer(bioguide);
              missed_votes_pct = await fetchMissedVotesPct(bioguide);
              committee_positions_score = await fetchCommitteePositionsScore(bioguide);
              bills_out_of_committee = await fetchBillsOutOfCommittee(bioguide);
            } else {
              console.warn('Missing bioguide or API key for', s.name, s.state || '');
            }

            return {
              name: s.name,
              office: s.office || 'Senator',
              party: normalizeParty(s.party),
              state: s.state,
              missed_votes_pct,
              bills_introduced,
              bills_cosponsored,
              laws_enacted,
              committee_positions_score,
              bills_out_of_committee,
              misconduct
            };
          }

          (async () => {
            const records = [];
            for (const s of senators) {
              const rec = await buildRecord(s);
              records.push(rec);
              console.log('OK:', rec.name, rec.state || '', 'laws_enacted:', rec.laws_enacted);
            }
            const outFile = path.join(process.cwd(), 'public', 'senators-rankings.json');
            fs.writeFileSync(outFile, JSON.stringify(records, null, 2), 'utf-8');
            console.log('Wrote', records.length, 'senators to', outFile);
          })();
NODE

      - name: Commit updated JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/senators-rankings.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update senators-rankings.json (full metrics)"
            git push
          fi
