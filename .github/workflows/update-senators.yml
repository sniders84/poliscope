name: Update civic data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # every 6 hours

jobs:
  update:
    runs-on: ubuntu-latest

    env:
      CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
      NODE_OPTIONS: --max_old_space_size=4096

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm ci
          npm install axios xml2js fast-xml-parser node-fetch --no-save

      # Senate pipeline
      - name: Bootstrap senators
        run: node scripts/bootstrap-senators.js

      - name: Legislation (Senate)
        run: node scripts/legislation-scraper.js

      - name: Committees (Senate)
        run: node scripts/committee-scraper.js   # <-- fixed to match your actual file

      - name: Votes (Senate)
        run: node scripts/votes-scraper.js

      - name: Merge (Senate)
        run: node scripts/merge-senators.js

      - name: Scores (Senate)
        run: node scripts/senators-scores.js

      # House pipeline
      - name: Bootstrap representatives
        run: node scripts/bootstrap-reps.js

      - name: Legislation (House)
        run: node scripts/legislation-reps-scraper.js

      - name: Committees (House)
        run: node scripts/committee-reps-scraper.js

      - name: Votes (House)
        run: node scripts/votes-reps-scraper.js

      - name: Merge (House)
        run: node scripts/merge-reps.js

      - name: Scores (House)
        run: node scripts/reps-scores.js

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated update: legislation, committees, votes, merge, scores"
          file_pattern: |
            public/senators-rankings.json
            public/representatives-rankings.json
